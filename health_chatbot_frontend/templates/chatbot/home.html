{% extends 'base.html' %}

{% block title %}Health Advice Chatbot - Home{% endblock %}

{% block content %}
<div class="main-container">
    <div class="row">
        <!-- Input Form -->
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-plus me-2"></i>
                        Your Health Profile
                    </h4>
                </div>
                <div class="card-body">
                    <form id="healthForm">
                        <!-- Basic Information -->
                        <div class="mb-3">
                            <label for="name" class="form-label">
                                <i class="fas fa-user me-1"></i>Name (Optional)
                            </label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Enter your name">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="age" class="form-label">
                                    <i class="fas fa-birthday-cake me-1"></i>Age
                                </label>
                                <input type="number" class="form-control" id="age" name="age" min="1" max="120" placeholder="25">
                            </div>
                            <div class="col-md-6">
                                <label for="gender" class="form-label">
                                    <i class="fas fa-venus-mars me-1"></i>Gender
                                </label>
                                <select class="form-control" id="gender" name="gender">
                                    <option value="">Select gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Physical Measurements -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="weight" class="form-label">
                                    <i class="fas fa-weight me-1"></i>Weight (kg)
                                </label>
                                <input type="number" class="form-control" id="weight" name="weight" step="0.1" min="20" max="300" required placeholder="70.0">
                            </div>
                            <div class="col-md-6">
                                <label for="height" class="form-label">
                                    <i class="fas fa-ruler-vertical me-1"></i>Height (cm)
                                </label>
                                <input type="number" class="form-control" id="height" name="height" step="0.1" min="100" max="250" required placeholder="175.0">
                            </div>
                        </div>

                        <!-- Activity Level -->
                        <div class="mt-3">
                            <label for="activity_level" class="form-label">
                                <i class="fas fa-running me-1"></i>Activity Level
                            </label>
                            <select class="form-control" id="activity_level" name="activity_level" required>
                                <option value="">Select activity level</option>
                                <option value="sedentary">Sedentary (Little or no exercise)</option>
                                <option value="light">Light (Light exercise 1-3 days/week)</option>
                                <option value="moderate" selected>Moderate (Moderate exercise 3-5 days/week)</option>
                                <option value="active">Active (Hard exercise 6-7 days/week)</option>
                                <option value="very_active">Very Active (Very hard exercise, physical job)</option>
                            </select>
                        </div>

                        <!-- Goals -->
                        <div class="mt-3">
                            <label for="goals" class="form-label">
                                <i class="fas fa-bullseye me-1"></i>Health Goals
                            </label>
                            <select class="form-control" id="goals" name="goals" required>
                                <option value="general_health" selected>General Health</option>
                                <option value="weight_loss">Weight Loss</option>
                                <option value="muscle_gain">Muscle Gain</option>
                                <option value="maintenance">Weight Maintenance</option>
                            </select>
                        </div>

                        <!-- Daily Routine -->
                        <div class="mt-3">
                            <label for="daily_routine" class="form-label">
                                <i class="fas fa-calendar-day me-1"></i>Daily Routine
                            </label>
                            <textarea class="form-control" id="daily_routine" name="daily_routine" rows="3" placeholder="Describe your typical daily routine (work, exercise, etc.)"></textarea>
                        </div>

                        <!-- Medical Conditions -->
                        <div class="mt-3">
                            <label for="medical_conditions" class="form-label">
                                <i class="fas fa-notes-medical me-1"></i>Medical Conditions (Optional)
                            </label>
                            <textarea class="form-control" id="medical_conditions" name="medical_conditions" rows="2" placeholder="Any medical conditions or medications"></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                                <i class="fas fa-magic me-2"></i>
                                Get Health Advice
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        Health Advice Chat
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Loading Spinner -->
                    <div class="loading" id="loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Generating personalized health advice...</p>
                    </div>

                    <!-- Chat Messages -->
                    <div class="chat-container" id="chatContainer">
                        <div class="message bot-message">
                            <strong><i class="fas fa-robot me-2"></i>Health Bot:</strong><br>
                            Hello! I'm your personal health advisor. Please fill out the form on the left with your information, and I'll provide you with personalized health, diet, and exercise recommendations.
                        </div>
                    </div>

                    <!-- Health Stats Display -->
                    <div id="healthStats" style="display: none;">
                        <div class="health-stats">
                            <h5><i class="fas fa-chart-line me-2"></i>Your Health Summary</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6>BMI</h6>
                                        <span id="bmiValue" class="h4">-</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6>Category</h6>
                                        <span id="bmiCategory" class="h6">-</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6>Calories</h6>
                                        <span id="caloriesNeeded" class="h4">-</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6>Goal</h6>
                                        <span id="userGoal" class="h6">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('healthForm');
    const chatContainer = document.getElementById('chatContainer');
    const loading = document.getElementById('loading');
    const healthStats = document.getElementById('healthStats');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading
        loading.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        
        // Get form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Add user message to chat
        addMessage('user', `I'm ${data.name || 'a user'}, ${data.age || 'unknown age'}, ${data.weight}kg, ${data.height}cm. Activity level: ${data.activity_level}. Goal: ${data.goals}.`);
        
        try {
            // Send request to Django backend
            const response = await fetch('{% url "chatbot:get_health_advice" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Display health stats
                displayHealthStats(result);
                
                // Add bot response
                addMessage('bot', result.advice);
                
                // Add recommendations
                if (result.recommendations) {
                    addRecommendations(result.recommendations);
                }
            } else {
                addMessage('bot', `Error: ${result.error || 'Failed to get health advice'}`);
            }
        } catch (error) {
            addMessage('bot', `Error: ${error.message}`);
        } finally {
            // Hide loading
            loading.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Get Health Advice';
        }
    });

    function addMessage(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        const icon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
        const name = sender === 'user' ? 'You' : 'Health Bot';
        
        messageDiv.innerHTML = `<strong><i class="${icon} me-2"></i>${name}:</strong><br>${text}`;
        chatContainer.appendChild(messageDiv);
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function displayHealthStats(data) {
        document.getElementById('bmiValue').textContent = data.bmi || '-';
        document.getElementById('bmiCategory').textContent = data.bmi_category || '-';
        document.getElementById('caloriesNeeded').textContent = data.calories_needed || '-';
        document.getElementById('userGoal').textContent = data.goals || '-';
        
        healthStats.style.display = 'block';
    }

    function addRecommendations(recommendations) {
        let recommendationsText = '<strong>Personalized Recommendations:</strong><br><br>';
        
        if (recommendations.diet) {
            recommendationsText += '<strong>🍽️ Diet:</strong><br>';
            for (const [key, value] of Object.entries(recommendations.diet)) {
                recommendationsText += `• ${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}<br>`;
            }
            recommendationsText += '<br>';
        }
        
        if (recommendations.exercise) {
            recommendationsText += '<strong>🏃 Exercise:</strong><br>';
            for (const [key, value] of Object.entries(recommendations.exercise)) {
                recommendationsText += `• ${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}<br>`;
            }
            recommendationsText += '<br>';
        }
        
        if (recommendations.lifestyle) {
            recommendationsText += '<strong>💚 Lifestyle:</strong><br>';
            for (const [key, value] of Object.entries(recommendations.lifestyle)) {
                recommendationsText += `• ${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}<br>`;
            }
        }
        
        addMessage('bot', recommendationsText);
    }
});
</script>
{% endblock %} 